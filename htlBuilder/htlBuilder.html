<!DOCTYPE html>
<!-- this is htlBuilder.html begun July 29, 2014 -->
<html>
<head>
  <meta charset="utf-8">
  <title>History Timeline Builder</title>
  <style>
body {
  background-color: yellow;
  font-family: Palatino, serif;
}
.tlContainer {
  padding: 20px 10px;
  border: 2px solid green;
  margin-bottom: 20px;
}
/* ==================== */
.panel {
  position: relative;
  width: 620px;
  margin: 0 auto;
  margin-bottom: 20px;
  padding: 5px;
  background-color: wheat;
}
.textboxDiv {
  margin-top: 10px;
}
form label {
  position: relative;
  top: 7px;
  text-align: right;
  color: red;
}
#startPanelForm label {
  float: left;
}
#eraPanel1, #eraPanel2, #nextStepPanel {
  display: none;
  overflow: hidden;
}
#eraPanel1 label {
  top: 0;
}
form input {
  font-size: 16px;
  border-radius: 5px;
  /* border: 5px solid white; */
  box-shadow: 
    inset 0 0 8px  rgba(0,0,0,0.1),
          0 0 16px rgba(0,0,0,0.1); 
  padding: 6px;
  background: rgba(255,255,255,0.5);
  margin: 0 0 10px 0;

  background-color: #D7EFFF; 
  border: 1px solid #646464; 
  outline: none; 
}
form input:focus {
  border: 2px solid red; 
}
form button {
  position: absolute;
  bottom: 24px;
  right: 20px;
  font-family: arial, sans-serif;
  font-size: 14px;
  padding: 4px;
  border-radius: 4px;
}
form button:hover {
  border: 2px solid red;
  cursor: pointer;
}
img {
  border: 1px solid black;
}
  </style>
</head>
<body>
  <h1>History Timeline Builder UI</h1>
  <div id="tlArr"></div>
  <div id="htlBuilderContainer" class="tlContainer">
    
    <!-- ================================================================ -->
    <div id="startPanel" class="panel">
      <h3>Step 1: The Bare Minimum</h3>
      <p class="orig">Please enter the <b>title</b> and <b>subtitle</b> (optional) of your timeline (they can be changed later) and the <b>beginning and ending years</b> for the <b>time axis</b> (BCE years are negative).</p>
     <div class="error" style="display: none; text-align: center; color: red;"></div> 
      <form id="startPanelForm" action="#" method="post">
        <div class="textboxDiv">
          <label for="title" style="width: 80px">Title: &nbsp;</label>
          <input type="text" class="title" name="title" value="" tabindex="1" 
                 size="50" placeholder="Enter the timeline's title here" />
                 <!-- for production, add autofocus here -->
        </div>      
        <div class="textboxDiv">
          <label for="subtitle" style="width: 80px">Subtitle: &nbsp;</label>
          <input type="text" class="subtitle" name="subtitle" value="" tabindex="2" 
                 size="50" placeholder="Enter the subtitle here" />
        </div>      
        <div class="textboxDiv">
          <label for="startYr" style="width: 200px">Begin Year: &nbsp;</label>
          <input type="text" class="startYr" name="startYr" value="" tabindex="3" 
                 size="6" placeholder="-1500" />
          <label for="stopYr" style="top: 0; margin-left: 20px; float: none">End Year: &nbsp;</label>
          <input type="text" class="stopYr" name="stopYr" value="" tabindex="4" 
                 size="6" placeholder="2014" />
        </div>
        <button type="button" class="doneBtn"/>Done</button>            
      </form>    ​
    </div>
    
    <!-- ================================================================ -->
    <div id="eraPanel1" class="panel">
      <h3>Step 2: Add Eras</h3>
      <p>Your <b>skeleton timeline</b> appears below.  You now enter the information about each of the <b>eras</b> you want to display, one at a time. An <b>era</b> is a rectangle usually occupying the full height of the timeline and representing some background condition such as the name of the period (e.g., Persian Period), the reign of a monarch (e.g., Louis XIV) or the like.</p>
      <p></p>
      <img src="images/eraExample.jpg" height="280" style="float: left; margin: 0 30px 10px 0;" alt="Image of an example Era" />
      <br /><br />
      <p>An era needs a label to identify it:</p>
      <form id="eraPanel1Form" action="#" method="post">
        <div class="textboxDiv">
          <label for="label">Label: &nbsp;</label>
          <input type="text" class="label" name="label" value="" tabindex="1" 
                 size="31" placeholder="Persian Period" />
                 <!-- for production, add autofocus here -->
        </div>      
      <p>And a beginning and ending year</p>
        <div class="textboxDiv">
          <label for="startYr">BeginYear: &nbsp;</label>
          <input type="text" class="startYr" name="startYr" value="" tabindex="2" 
                 size="6" placeholder="-1500" />
          <label for="stopYr" style="margin-left: 20px;">End Year: &nbsp;</label>
          <input type="text" class="stopYr" name="stopYr" value="" tabindex="3" 
                 size="6" placeholder="2014" />
        </div>
        <button type="button" class="doneBtn"/>Done</button>            
      </form>    ​
    </div>
    
    <!-- ================================================================ -->
    <div id="eraPanel2" class="panel">
      <h3>Step 3: Add Another Era</h3>
      <p>You can see the result of adding the previous era below. If there is another era to add, enter the information here.  If not, leave all fields empty and just click on Done.</p>
      <form id="eraPanel2Form" action="#" method="post">
        <div class="textboxDiv">
          <label for="label">Label: &nbsp;</label>
          <input type="text" class="label" name="label" value="" tabindex="1" 
                 size="31" placeholder="Persian Period" />
                 <!-- for production, add autofocus here -->
        </div>      
        <div class="textboxDiv">
          <label for="startYr">BeginYear: &nbsp;</label>
          <input type="text" class="startYr" name="startYr" value="" tabindex="2" 
                 size="6" placeholder="-1500" />
          <label for="stopYr" style="margin-left: 20px;">End Year: &nbsp;</label>
          <input type="text" class="stopYr" name="stopYr" value="" tabindex="3" 
                 size="6" placeholder="2014" />
        </div>
        <button type="button" class="doneBtn" tabindex="4">Done</button>            
      </form>    ​
    </div>
    
    <!-- ================================================================ -->
    <div id="nextStepPanel" class="panel">
      <h3>Several options for proceeding:</h3>
      <p>If you need to change any of the information entered about eras or you want to modify the default values of advanced properties, click <b>Edit Eras</b>.</p>
      <p>To add graphic elements which represent one-time events, click <b>Add Events</b>.</p>
      <p>To add graphic elements which describe people (their lifetimes, their active periods, their reigns), click <b>Add People</b>.</p>
      <div class="buttonsDiv" style="text-align: center;">
        <button type="button" class="editEras">Edit Eras</button><br />
        <button type="button" class="addEvents">Add Events</button><br />
        <button type="button" class="addPeople">Add People</button>
      </div>            
    </div>
    
    <!-- ================================================================ -->

  </div> <!-- END OF htlBuilderContainer -->
  <div id="currentTLContainer" class="tlContainer" style="display: none;"></div>
  <script src="../js/d3.v3.4.11.min.js"></script>
  <script src="../js/jquery-2.1.1.min.js"></script> 
  <script src="../js/historytimeline.js"></script>
  <script>
    var currtl = new d3.tl.Timeline();
    // set timeaxis defaults and empty erasArr;
    currtl.axisStartYr = -1500;
    currtl.axisStopYr  = 2014;
    currtl.erasArr = [];
    currtl.bgcolorsArr = [ "#A9BCF5", "#F5BCA9", "#F5A9E1", "#F5A9BC",
                           "#F78181", "#A9BCF5", "#A9E2F3", "#F5A9E1",
                           "#F5BCA9",
                           "#A9BCF5", "#F5BCA9", "#F5A9E1", "#F5A9BC",
                           "#F78181", "#A9BCF5", "#A9E2F3", "#F5A9E1",
                           "#F5BCA9" ];

    $( document ).ready(function() {
// for production, add autofocus attribute to HTML forms;

d3.tl.storedTimelinesArr = null;
// debug:
localStorage.removeItem("timelines");
localStorage.clear();
tlArr = getStoredTimelines();
saveTimelinesToStorage(tlArr);
// console.log("JSON: " + localStorage.getItem("timelines"));
// console.log("HTML: " + generateDisplayHTML(tlArr));
$("#tlArr").html(generateDisplayHTML(tlArr));

$("#startPanelForm .doneBtn").on("click", function (event) {
  $(event.target).attr("disabled", "true");
  if (!validateStartPanel("#startPanelForm")) { return false; };
  $("#startPanel").slideUp(600, function () {
    currtl.title    = $.trim($("#startPanelForm .title").val());
    currtl.subtitle = $.trim($("#startPanelForm .subtitle").val());
    currtl.axisStartYr = parseInt($("#startPanelForm .startYr").val());
    currtl.axisStopYr  = parseInt($("#startPanelForm .stopYr").val());
    currtl.setup("currentTLContainer");
    currtl.draw();
    $("#eraPanel1").slideDown(600, function () {
      $("#currentTLContainer").fadeIn(600);
    });
  });
});

$("#eraPanel1Form .doneBtn").on("click", function (event) {
  $(event.target).attr("disabled", "true");
  if (!validateEraPanel("#eraPanel1Form")) { return false; };
  $("#eraPanel1").slideUp(600, function () {
    installNewEra("#eraPanel1Form", currtl.bgcolorsArr.shift());
    currtl.removeTimelineContents();
    currtl.draw();
    $("#eraPanel2").slideDown(600);
  });
});

$("#eraPanel2Form .doneBtn").on("click", function (event) {
  $(event.target).attr("disabled", true);
  if (eraPanel2IsEmpty()) {
    console.log("Empty");
    // store timeline in current state;
    addTimelineToStorage(currtl);
    $("#tlArr").html(generateDisplayHTML(tlArr));
    $("#eraPanel2").slideUp(600, function () {
      $("#nextStepPanel").slideDown(600);
    });
  };
  if (!validateEraPanel("#eraPanel2Form")) { return false; };
  $("#eraPanel2").slideUp(600, function () {
    installNewEra("#eraPanel2Form", currtl.bgcolorsArr.shift());
    currtl.removeTimelineContents();
    currtl.draw();
    // change headline;
    $("#eraPanel2 h3").html("&nbsp;&nbsp;Continue adding eras:");
    // reset inputs;
    $("#eraPanel2Form .label").val("");
    $("#eraPanel2Form .startYr").val("");
    $("#eraPanel2Form .stopYr").val("");
    $("#eraPanel2Form .doneBtn").attr("disabled", false);
    $("#eraPanel2").slideDown(600);
  });
});

/* ========= AUTO TESTING =============================== */
currtl.showD3selectionsInConsole = false;
if (false) { autoTest(); };
if (true) {
  $("h1").on("click", function () {
    autoTest();
  });
};

function autoTest4 () {
  $("#eraPanel2Form .label").val("Maccabean (Hasmonean) Rule");
  $("#eraPanel2Form .startYr").val("-168");
  $("#eraPanel2Form .stopYr").val("-63");
  $("#eraPanel2Form .doneBtn").trigger("click");
  
  // store this new timeline;
  
  // displayStoredTimelines();
  console.log("END OF AUTOTEST");
}

function autoTest3 () {
  $("#eraPanel2Form .label").val("Helenistic Period");
  $("#eraPanel2Form .startYr").val("-332");
  $("#eraPanel2Form .stopYr").val("-168");
  $("#eraPanel2Form .doneBtn").trigger("click");
  
  window.setTimeout(autoTest4, 2500);
}

function autoTest2 () {
  $("#eraPanel1Form .label").val("Persian Period");
  $("#eraPanel1Form .startYr").val("-539");
  $("#eraPanel1Form .stopYr").val("-332");
  $("#eraPanel1Form .doneBtn").trigger("click");
  
  window.setTimeout(autoTest3, 2500);
}

function autoTest () {
  $("#startPanelForm .title").val("The Hebrew Bible");
  $("#startPanelForm .subtitle").val("(automated testing)");
  $("#startPanelForm .startYr").val("-1100");
  $("#startPanelForm .stopYr").val("100");
  $("#startPanelForm .doneBtn").trigger("click");
  
  window.setTimeout(autoTest2, 2500);
}

/* ========= HELPER FUNCTIONS =============================== */
function addTimelineToStorage (currtl) {
  // assign serial id;
  var highestExistingID = tlArr[tlArr.length -1].tlid;
  currtl.tlid = highestExistingID + 1;
  currtl.lastModified = new Date();
  console.log("Before: ", tlArr.length);
  tlArr.push(currtl);
  console.log("After:  ", tlArr.length);
  console.log(currtl);
  saveTimelinesToStorage(tlArr);
}

function eraPanel2IsEmpty () {
  var retVal = true;
  $("#eraPanel2Form input").each( function (idx) {
    if ($(this).val() !== "") { retVal = false; };
  });
  return retVal;
}

function installNewEra (panelForm, bgcolor) {
  // instantiate a new Era; transfer input values;
  var newEra = new d3.tl.Era();
  newEra.label = $(panelForm + " .label").val();
  newEra.start = $(panelForm + " .startYr").val();
  newEra.stop  = $(panelForm + " .stopYr").val();
  if (bgcolor) { newEra.bgcolor = bgcolor; };
  currtl.erasArr.push(newEra);
  currtl.removeTimelineContents();
  currtl.draw(); 
}

function validateStartPanel () {
  // validate: title req, start < stop and numeric;
  if ($("#startPanelForm .title").val() === "") {
    showErrorMsg("#startPanel", ".title", "You need to provide a <b>title</b> for the timeline before we continue.<br />&nbsp;");
    return false;
  };
  if (!validateStartStopYrs($("#startPanelForm .startYr").val(),
                            $("#startPanelForm .stopYr").val())) { return false; }
  return true;
}

function validateEraPanel (panelForm) {
  console.log("validateEraPanel: " + panelForm + "; label: **" +
              $(panelForm + " .label").val() + "**");
  // validate: label req, start < stop and numeric;
  if ($(panelForm + " .label").val() === "") {
    // new 1st arg;
    showErrorMsg("#startPanel", ".label", "You need to provide a <b>label</b> for the timeline before we continue.<br />&nbsp;");
    return false;
  };
  console.log("  start: " + $(panelForm + " .startYr").val() +
              ";  stop: " + $(panelForm + " .stopYr").val());
  if (!validateStartStopYrs($(panelForm + " .startYr").val(),
                            $(panelForm + " .stopYr").val())) { return false; }
  return true;
}

function validateStartStopYrs (startYr, stopYr) {
  // coerce to numbers;
  startYr = parseInt(startYr);
  stopYr  = parseInt(stopYr);
  if (!$.isNumeric(startYr)) {
    showErrorMsg("#startPanel", ".startYr", "The <b>Begin Year</b> must be a number. If BCE, it should be negative (e.g., -350).<br />&nbsp;");
    return false;
  };
  if (!$.isNumeric(stopYr)) {
    showErrorMsg("#startPanel", ".stopYr", "The <b>End Year</b> must be a number. If BCE, it should be negative (e.g., -350).<br />&nbsp;");
    return false;
  };
  if (startYr >= stopYr) {
    showErrorMsg("#startPanel", ".startYr", "The <b>Begin Year</b> must come before the <b>End Year</b>. A year BCE should be negative (e.g., -350). Please change the incorrect one.");
    return false;
  };
  return true;
}

function showErrorMsg (panelSel, textboxClass, msgHTML) {
  $(panelSel + " .error").html(msgHTML);
  $(panelSel + " .orig").hide();
  $(panelSel + " .error").fadeIn();
  $(panelSel + "Form " + textboxClass).focus();
}

/* ==================================================================
         LOCAL STORAGE
         
   setItem(str, str); getItem(str); removeItem(str); clear(); length();
   key(idx) => str
         
   Timelines are stored with the key "timelines" as an array of timeline
   objects:
    [ {"tlid": 1, "title": "The Hebrew Bible", . . .} ... ]
   ================================================================== */

function getStoredTimelines() {
  // if not present, initialize;
  var tlArr = JSON.parse(localStorage.getItem("timelines")) ||
              [ 
                {"tlid": 5, "title": "Dummy Timeline5"},
                {"tlid": 2, "title": "Dummy Timeline2"},
                {"tlid": 10, "title": "Dummy Timeline10"},
                {"tlid": 8, "title": "Dummy Timeline8"}
              ];

  // console.log("Before: ", tlArr);
  // sort on tlid;
  tlArr = tlArr.sort(function (a, b) { return a.tlid - b.tlid; });
  // console.log("After:  ", tlArr);
  
  return tlArr;
}

function saveTimelinesToStorage(tlArr) {
  try {
    localStorage.setItem("timelines", JSON.stringify(tlArr));
  } catch (e) {
    if (e == QUOTA_EXCEEDED_ERR) { alert("Quota exceeded!"); }
  }
}

function generateDisplayHTML (tlArr) {
  var html = "<ol>";
  tlArr.forEach( function (tl) {
    html += "<li><span class=\"id\">" + tl.tlid + ": </span>" +
                "<span class=\"title\">" + tl.title + "</span>" +
            "</li>";
  });
  return html + "</ol>";
}


function addTimelineToStorage (tl) {
}

/* =================================================================== */
    }); // END OF document.#ready
  </script>
</body>
</html>
